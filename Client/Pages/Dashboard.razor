@page "/dashboard"
@using VitrineFr.Services
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject HttpClient Http

<PageTitle>Espace Client - LABOR CONTROL</PageTitle>

<link href="css/professional.css" rel="stylesheet" />

<!-- Modal de choix pour SUPERADMIN -->
@if (isAuthenticated && showRoleModal && userRole == "SUPERADMIN")
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl max-w-md w-full mx-4">
            <div class="p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Bienvenue SuperAdmin</h2>
                <p class="text-gray-600 mb-8">Choisissez votre mode de fonctionnement :</p>

                <div class="space-y-4">
                    <button @onclick="() => NavigateToGestion()"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition-all duration-300 hover:shadow-lg">
                        <div class="flex items-center justify-center space-x-2">
                            <span class="text-xl">‚öôÔ∏è</span>
                            <div class="text-left">
                                <div>Gestion</div>
                                <div class="text-sm opacity-90">Interface d'administration</div>
                            </div>
                        </div>
                    </button>

                    <button @onclick="() => NavigateToAcces()"
                            class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-4 rounded-lg transition-all duration-300 hover:shadow-lg">
                        <div class="flex items-center justify-center space-x-2">
                            <span class="text-xl">üë§</span>
                            <div class="text-left">
                                <div>Acc√®s Client</div>
                                <div class="text-sm opacity-90">Interface utilisateur</div>
                            </div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Navigation Client -->
<nav class="lc-nav fixed w-full z-50">
    <div class="max-w-7xl mx-auto px-6 py-4">
        <div class="flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div>
                    <img src="logo-lc.png" alt="Logo LC" class="h-10 w-10" />
                </div>
                <span class="font-bold text-2xl">
                    <span class="text-cyan-400">LABOR</span>
                    <span class="text-blue-800"> CONTROL</span>
                </span>
            </div>
            <div class="flex items-center space-x-6">
                <span class="text-blue-600 font-bold text-lg">@companyName</span>
                <span class="text-gray-600 text-sm">@userFullName</span>
                <button @onclick="Logout" class="text-sm text-gray-600 hover:text-red-600 transition font-medium">
                    D√©connexion
                </button>
            </div>
        </div>
    </div>
</nav>

<div class="min-h-screen bg-gray-50 pt-24 pb-12">
    <div class="max-w-7xl mx-auto px-6">
        <!-- Actions rapides -->
        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Compte (Catalogue + Commandes + D√©tails) -->
            <div class="relative h-full">
                <button @onclick="ToggleAccountMenu" class="lc-card w-full h-full flex flex-col text-left">
                    <div class="flex items-center justify-between mb-3">
                        <div class="lc-card-icon">
                            <svg class="lc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.25c0 1.094-.787 2.036-1.872 2.18-2.087.277-4.216.42-6.378.42s-4.291-.143-6.378-.42c-1.085-.144-1.872-1.086-1.872-2.18v-4.25m16.5 0a2.18 2.18 0 00.75-1.661V8.706c0-1.081-.768-2.015-1.837-2.175a48.114 48.114 0 00-3.413-.387m4.5 8.006c-.194.165-.42.295-.673.38A23.978 23.978 0 0112 15.75c-2.648 0-5.195-.429-7.577-1.22a2.016 2.016 0 01-.673-.38m0 0A2.18 2.18 0 013 12.489V8.706c0-1.081.768-2.015 1.837-2.175a48.111 48.111 0 013.413-.387m7.5 0V5.25A2.25 2.25 0 0013.5 3h-3a2.25 2.25 0 00-2.25 2.25v.894m7.5 0a48.667 48.667 0 00-7.5 0M12 12.75h.008v.008H12v-.008z" />
                            </svg>
                        </div>
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                    <h3 class="lc-card-title">Compte</h3>
                    <p class="lc-card-description">G√©rez votre compte et vos commandes</p>
                </button>

                @if (showAccountMenu)
                {
                    <div class="lc-dropdown absolute top-full left-0 mt-2 w-full z-50">
                        <a href="/catalog" class="lc-dropdown-item flex items-center">
                            <svg class="lc-icon mr-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.272M6 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm12.75 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0z" />
                            </svg>
                            <div>
                                <div class="lc-dropdown-item-title">Catalogue produits</div>
                                <div class="lc-dropdown-item-subtitle">Puces NFC, abonnements...</div>
                            </div>
                        </a>
                        <a href="/orders" class="lc-dropdown-item flex items-center">
                            <svg class="lc-icon mr-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
                            </svg>
                            <div>
                                <div class="lc-dropdown-item-title">Commandes</div>
                                <div class="lc-dropdown-item-subtitle">Suivi et historique</div>
                            </div>
                        </a>
                        <a href="/account-details" class="lc-dropdown-item flex items-center">
                            <svg class="lc-icon mr-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                            </svg>
                            <div>
                                <div class="lc-dropdown-item-title">D√©tails du compte</div>
                                <div class="lc-dropdown-item-subtitle">Informations et param√®tres</div>
                            </div>
                        </a>
                    </div>
                }
            </div>

            <!-- Gestion du personnel -->
            <a href="/personnel" class="lc-card block">
                <div class="flex items-center justify-between mb-3">
                    <div class="lc-card-icon">
                        <svg class="lc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                        </svg>
                    </div>
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </div>
                <h3 class="lc-card-title">Gestion du personnel</h3>
                <p class="lc-card-description">Cr√©ez et g√©rez vos utilisateurs (techniciens, superviseurs...)</p>
            </a>

            <!-- √âquipes -->
            <a href="/teams" class="lc-card block">
                <div class="flex items-center justify-between mb-3">
                    <div class="lc-card-icon">
                        <svg class="lc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z" />
                        </svg>
                    </div>
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </div>
                <h3 class="lc-card-title">√âquipes</h3>
                <p class="lc-card-description">G√©rez vos √©quipes et affectations</p>
            </a>

            <!-- M√©tiers et Qualifications -->
            <div class="relative h-full">
                <button @onclick="ToggleQualificationsMenu" class="lc-card w-full h-full flex flex-col text-left">
                    <div class="flex items-center justify-between mb-3">
                        <div class="lc-card-icon">
                            <svg class="lc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.436 60.436 0 00-.491 6.347A48.627 48.627 0 0112 20.904a48.627 48.627 0 018.232-4.41 60.46 60.46 0 00-.491-6.347m-15.482 0a50.57 50.57 0 00-2.658-.813A59.905 59.905 0 0112 3.493a59.902 59.902 0 0110.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0112 13.489a50.702 50.702 0 017.74-3.342M6.75 15a.75.75 0 100-1.5.75.75 0 000 1.5zm0 0v-3.675A55.378 55.378 0 0112 8.443m-7.007 11.55A5.981 5.981 0 006.75 15.75v-1.5" />
                            </svg>
                        </div>
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                    <h3 class="lc-card-title">M√©tiers et Qualifications</h3>
                    <p class="lc-card-description">G√©rez vos m√©tiers et comp√©tences</p>
                </button>

                @if (showQualificationsMenu)
                {
                    <div class="lc-dropdown absolute top-full left-0 mt-2 w-full z-50">
                        <a href="/sectors" class="lc-dropdown-item flex items-center">
                            <svg class="lc-icon mr-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M6.75 21v-3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21M3 3h12m-.75 4.5H21m-3.75 3.75h.008v.008h-.008v-.008zm0 3h.008v.008h-.008v-.008zm0 3h.008v.008h-.008v-.008z" />
                            </svg>
                            <div>
                                <div class="lc-dropdown-item-title">Secteurs d'activit√©</div>
                                <div class="lc-dropdown-item-subtitle">Maintenance, QHSE, Sant√©, Commerce...</div>
                            </div>
                        </a>
                        <a href="/industries" class="lc-dropdown-item flex items-center">
                            <svg class="lc-icon mr-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
                            </svg>
                            <div>
                                <div class="lc-dropdown-item-title">M√©tiers</div>
                                <div class="lc-dropdown-item-subtitle">Par secteur d'activit√©</div>
                            </div>
                        </a>
                        <a href="/qualifications" class="lc-dropdown-item flex items-center">
                            <svg class="lc-icon mr-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.436 60.436 0 00-.491 6.347A48.627 48.627 0 0112 20.904a48.627 48.627 0 018.232-4.41 60.46 60.46 0 00-.491-6.347m-15.482 0a50.57 50.57 0 00-2.658-.813A59.905 59.905 0 0112 3.493a59.902 59.902 0 0110.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0112 13.489a50.702 50.702 0 017.74-3.342M6.75 15a.75.75 0 100-1.5.75.75 0 000 1.5zm0 0v-3.675A55.378 55.378 0 0112 8.443m-7.007 11.55A5.981 5.981 0 006.75 15.75v-1.5" />
                            </svg>
                            <div>
                                <div class="lc-dropdown-item-title">Qualifications</div>
                                <div class="lc-dropdown-item-subtitle">CACES, habilitations, certifications...</div>
                            </div>
                        </a>
                    </div>
                }
            </div>
        </div>

        <!-- Gestion des sites et points de contr√¥le -->
        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Sites -->
            <a href="/sites" class="lc-card block">
                <div class="flex items-center justify-between mb-3">
                    <div class="lc-card-icon">
                        <svg class="lc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
                        </svg>
                    </div>
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </div>
                <h3 class="lc-card-title">Sites</h3>
                <p class="lc-card-description">G√©rez vos sites et leur configuration</p>
            </a>

            <!-- Zones -->
            <a href="/zones" class="lc-card block">
                <div class="flex items-center justify-between mb-3">
                    <div class="lc-card-icon">
                        <svg class="lc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h1.5m-1.5 3h1.5m-1.5 3h1.5m3-6H15m-1.5 3H15m-1.5 3H15M9 21v-3.375c0-.621.504-1.125 1.125-1.125h3.75c.621 0 1.125.504 1.125 1.125V21" />
                        </svg>
                    </div>
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </div>
                <h3 class="lc-card-title">Zones</h3>
                <p class="lc-card-description">Organisez vos zones par site (b√¢timents, √©tages, locaux...)</p>
            </a>

            <!-- √âquipements -->
            <a href="/equipment" class="lc-card block">
                <div class="flex items-center justify-between mb-3">
                    <div class="lc-card-icon">
                        <svg class="lc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 11-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 004.486-6.336l-3.276 3.277a3.004 3.004 0 01-2.25-2.25l3.276-3.276a4.5 4.5 0 00-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437l1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008z" />
                        </svg>
                    </div>
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </div>
                <h3 class="lc-card-title">√âquipements</h3>
                <p class="lc-card-description">G√©rez vos √©quipements et actifs</p>
            </a>

            <!-- Points de contr√¥le -->
            <a href="/controlpoints" class="lc-card block">
                <div class="flex items-center justify-between mb-3">
                    <div class="lc-card-icon">
                        <svg class="lc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </div>
                <h3 class="lc-card-title">Points de Contr√¥le</h3>
                <p class="lc-card-description">G√©rez vos points de contr√¥le et affectez vos puces RFID</p>
            </a>

            <!-- Planification -->
            <div class="relative h-full">
                <button @onclick="TogglePlanningMenu" class="lc-card w-full h-full flex flex-col text-left">
                    <div class="flex items-center justify-between mb-3">
                        <div class="lc-card-icon">
                            <svg class="lc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                            </svg>
                        </div>
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                    <h3 class="lc-card-title">Planification</h3>
                    <p class="lc-card-description">Planifiez et g√©rez les t√¢ches de maintenance</p>
                </button>

                @if (showPlanningMenu)
                {
                    <div class="lc-dropdown absolute top-full left-0 mt-2 w-full z-50">
                        <a href="/calendar" class="lc-dropdown-item flex items-center">
                            <svg class="lc-icon mr-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                            </svg>
                            <div>
                                <div class="lc-dropdown-item-title">Planning</div>
                                <div class="lc-dropdown-item-subtitle">Vue calendrier des t√¢ches</div>
                            </div>
                        </a>
                        <a href="/alerts" class="lc-dropdown-item flex items-center">
                            <svg class="lc-icon mr-3 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                            </svg>
                            <div>
                                <div class="lc-dropdown-item-title text-red-600">üö® Alertes</div>
                                <div class="lc-dropdown-item-subtitle">Maintenances en retard</div>
                            </div>
                        </a>
                        <a href="/tasks-dashboard" class="lc-dropdown-item flex items-center">
                            <svg class="lc-icon mr-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11.35 3.836c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m8.9-4.414c.376.023.75.05 1.124.08 1.131.094 1.976 1.057 1.976 2.192V16.5A2.25 2.25 0 0118 18.75h-2.25m-7.5-10.5H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V18.75m-7.5-10.5h6.375c.621 0 1.125.504 1.125 1.125v9.25m-12 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                            </svg>
                            <div>
                                <div class="lc-dropdown-item-title">Tableau de bord</div>
                                <div class="lc-dropdown-item-subtitle">Statistiques et suivi</div>
                            </div>
                        </a>
                    </div>
                }
            </div>

            <!-- Protocoles -->
            <a href="/task-templates" class="lc-card block">
                <div class="flex items-center justify-between mb-3">
                    <div class="lc-card-icon">
                        <svg class="lc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" />
                        </svg>
                    </div>
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </div>
                <h3 class="lc-card-title">Protocoles</h3>
                <p class="lc-card-description">Cr√©ez et g√©rez vos protocoles d'intervention</p>
            </a>

            <!-- Historique interventions -->
            <a href="/task-executions" class="lc-card block">
                <div class="flex items-center justify-between mb-3">
                    <div class="lc-card-icon">
                        <svg class="lc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
                        </svg>
                    </div>
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </div>
                <h3 class="lc-card-title">Historique interventions</h3>
                <p class="lc-card-description">Consultez toutes les interventions effectu√©es avec photos et donn√©es</p>
            </a>

            <!-- Tableau de bord -->
            <a href="/tasks-dashboard" class="lc-card block">
                <div class="flex items-center justify-between mb-3">
                    <div class="lc-card-icon">
                        <svg class="lc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11.35 3.836c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m8.9-4.414c.376.023.75.05 1.124.08 1.131.094 1.976 1.057 1.976 2.192V16.5A2.25 2.25 0 0118 18.75h-2.25m-7.5-10.5H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V18.75m-7.5-10.5h6.375c.621 0 1.125.504 1.125 1.125v9.25m-12 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                        </svg>
                    </div>
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </div>
                <h3 class="lc-card-title">Tableau de bord</h3>
                <p class="lc-card-description">Vue d'ensemble de toutes vos interventions planifi√©es</p>
            </a>
        </div>

        <!-- Offre sp√©ciale (masqu√©e si des puces ont d√©j√† √©t√© command√©es) -->
        @if (totalChipsOrdered == 0)
        {
            <div class="bg-white border-l-4 border-green-600 rounded-lg p-6 shadow-sm mb-8">
                <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0 w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-900 mb-1">
                            Offre de lancement : 10 puces gratuites
                        </h3>
                        <p class="text-gray-600 text-sm mb-4">
                            En tant que nouveau client, vous avez droit √† <strong>10 puces NFC gratuites</strong> pour d√©marrer. Profitez-en pour tester notre solution sur vos premiers sites.
                        </p>
                        <a href="/order-chips" class="lc-btn lc-btn-primary inline-flex items-center">
                            Commander mes 10 puces gratuites
                            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
        }

        <!-- Support -->
        <div class="mt-8 text-center border-t border-gray-200 pt-6">
            <p class="lc-text-muted mb-3">Besoin d'aide ? Notre √©quipe est √† votre disposition</p>
            <a href="mailto:support@labor-control.fr" class="inline-flex items-center text-gray-700 hover:text-gray-900 font-medium transition">
                <svg class="w-5 h-5 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                support@labor-control.fr
            </a>
        </div>
    </div>
</div>

@code {
    private bool isAuthenticated = false;
    private bool showRoleModal = false;
    private string userRole = "";
    private string userEmail = "";
    private string userFullName = "Utilisateur";
    private string companyName = "Ma Soci√©t√© Test";
    private bool hasPackDiscovery = false;
    private string currentSubscriptionTier = "Gratuit";
    private int sitesCount = 0;
    private int techniciansCount = 0;
    private int supervisorsCount = 0;
    private int totalChipsOrdered = 0;
    private bool showAccountMenu = false;
    private bool showQualificationsMenu = false;
    private bool showPlanningMenu = false;

    protected override async Task OnInitializedAsync()
    {
        isAuthenticated = await AuthService.IsAuthenticatedAsync();

        if (!isAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        userRole = await AuthService.GetUserRoleAsync() ?? "";

        // V√©rifier si le param√®tre showRoleModal est pr√©sent
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        if (uri.Query.Contains("showRoleModal=true"))
        {
            showRoleModal = true;
        }

        // Charger toutes les donn√©es
        await LoadDashboardData();
    }

    private void NavigateToGestion()
    {
        Navigation.NavigateTo("/admin-lc/dashboard");
    }

    private void NavigateToAcces()
    {
        showRoleModal = false;
        StateHasChanged();
    }

    private async Task LoadDashboardData()
    {
        try
        {
            var token = await AuthService.GetTokenAsync();
            if (string.IsNullOrEmpty(token)) return;

            Http.DefaultRequestHeaders.Authorization =
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            // R√©cup√©rer les informations du client
            var customerResponse = await Http.GetAsync("http://localhost:5278/api/customers/me");
            Console.WriteLine($"Customer API Response Status: {customerResponse.StatusCode}");
            if (customerResponse.IsSuccessStatusCode)
            {
                var customer = await customerResponse.Content.ReadFromJsonAsync<CustomerResponse>();
                if (customer != null)
                {
                    companyName = customer.Name ?? "Non renseign√©";
                    userEmail = customer.ContactEmail ?? userEmail; // Utiliser ContactEmail de l'API
                    Console.WriteLine($"Company Name loaded: {companyName}");
                }
                else
                {
                    Console.WriteLine("Customer is null after deserialization");
                }
            }
            else
            {
                var errorContent = await customerResponse.Content.ReadAsStringAsync();
                Console.WriteLine($"Customer API Error: {errorContent}");
            }

            // R√©cup√©rer les informations de l'utilisateur connect√©
            var userResponse = await Http.GetAsync("http://localhost:5278/api/users/me");
            Console.WriteLine($"User API Response Status: {userResponse.StatusCode}");
            if (userResponse.IsSuccessStatusCode)
            {
                var user = await userResponse.Content.ReadFromJsonAsync<UserResponse>();
                if (user != null)
                {
                    userFullName = $"{user.Prenom} {user.Nom}".Trim();
                    Console.WriteLine($"User full name loaded: {userFullName}");
                }
                else
                {
                    Console.WriteLine("User is null after deserialization");
                }
            }
            else
            {
                var errorContent = await userResponse.Content.ReadAsStringAsync();
                Console.WriteLine($"User API Error: {errorContent}");
                userFullName = "Utilisateur"; // Valeur par d√©faut
            }

            // R√©cup√©rer les commandes pour calculer les puces et le forfait
            var ordersResponse = await Http.GetAsync("http://localhost:5278/api/orders");
            if (ordersResponse.IsSuccessStatusCode)
            {
                var orders = await ordersResponse.Content.ReadFromJsonAsync<List<OrderSummary>>();
                if (orders != null)
                {
                    // V√©rifier s'il y a au moins une commande de pack d√©couverte non annul√©e
                    hasPackDiscovery = orders.Any(o =>
                        o.ProductType == "pack_discovery" &&
                        o.Status != "CANCELLED");

                    // Calculer le total de puces command√©es
                    totalChipsOrdered = orders
                        .Where(o => o.Status != "CANCELLED")
                        .Sum(o => o.ChipsQuantity);

                    // D√©terminer le forfait en cours
                    if (totalChipsOrdered <= 10)
                        currentSubscriptionTier = "Gratuit";
                    else if (totalChipsOrdered <= 25)
                        currentSubscriptionTier = "Starter (49‚Ç¨/mois)";
                    else if (totalChipsOrdered <= 50)
                        currentSubscriptionTier = "Medium (99‚Ç¨/mois)";
                    else
                        currentSubscriptionTier = "Corporate (sur devis)";
                }
            }

            // TODO: R√©cup√©rer le nombre de sites depuis l'API (quand les tables seront cr√©√©es)
            sitesCount = 0;

            // TODO: R√©cup√©rer le nombre de techniciens depuis l'API (quand les tables seront cr√©√©es)
            techniciansCount = 0;

            // TODO: R√©cup√©rer le nombre de superviseurs depuis l'API (quand les tables seront cr√©√©es)
            supervisorsCount = 0;

            // Forcer le rafra√Æchissement de l'interface avec les nouvelles donn√©es
            StateHasChanged();
        }
        catch
        {
            // En cas d'erreur, on laisse les valeurs par d√©faut
        }
    }

    private async Task Logout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/");
    }

    private void ToggleAccountMenu()
    {
        showAccountMenu = !showAccountMenu;
    }

    private void ToggleQualificationsMenu()
    {
        showQualificationsMenu = !showQualificationsMenu;
    }

    private void TogglePlanningMenu()
    {
        showPlanningMenu = !showPlanningMenu;
    }

    private class OrderSummary
    {
        public Guid Id { get; set; }
        public string Status { get; set; } = string.Empty;
        public string? ProductType { get; set; }
        public int ChipsQuantity { get; set; }
    }

    private class CustomerResponse
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Sector { get; set; } = string.Empty;
        public string SubscriptionPlan { get; set; } = string.Empty;
        public string? ContactName { get; set; }
        public string ContactEmail { get; set; } = string.Empty;
        public string? ContactPhone { get; set; }
        public string? Address { get; set; }
        public string? Siret { get; set; }
        public string? Description { get; set; }
        public DateTime CreatedAt { get; set; }
    }

    private class UserResponse
    {
        public Guid Id { get; set; }
        public string Nom { get; set; } = string.Empty;
        public string Prenom { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string? Service { get; set; }
        public string? Fonction { get; set; }
        public string Role { get; set; } = string.Empty;
    }
}
