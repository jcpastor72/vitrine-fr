@page "/register"
@using VitrineFr.Services
@using System.Net.Http
@using System.Net.Http.Json
@using System.Text.Json
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject HttpClient Http

<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8 bg-white p-8 rounded-xl shadow-2xl">
        <div>
            <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                Cr√©ez votre compte LABOR CONTROL
            </h2>
            <p class="mt-2 text-center text-sm text-gray-600">
                Remplissez le formulaire ci-dessous pour commencer
            </p>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                <span class="block sm:inline">@errorMessage</span>
            </div>
        }

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative" role="alert">
                <span class="block sm:inline">@successMessage</span>
            </div>
        }

        <form class="mt-8 space-y-6" @onsubmit="HandleRegister">
            <div class="rounded-md shadow-sm space-y-4">
                <!-- SIRET - EN PREMIER -->
                <div>
                    <label for="siret" class="block text-sm font-medium text-gray-700">N¬∞ SIRET * (Commencez par ici)</label>
                    <input id="siret"
                           type="text"
                           value="@siret"
                           @onchange="OnSiretChange"
                           @onblur="ValidateSiret"
                           required
                           disabled="@isValidatingSiret"
                           class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm"
                           placeholder="Vous pouvez coller votre SIRET avec espaces"
                           oninput="this.value = this.value.replace(/\D/g, '').substring(0, 14)">
                    @if (isValidatingSiret)
                    {
                        <p class="mt-1 text-xs text-blue-600">üîç V√©rification du SIRET en cours...</p>
                    }
                    else if (siretValidated && !string.IsNullOrEmpty(siret) && siret.Length == 14)
                    {
                        <p class="mt-1 text-xs text-green-600">‚úÖ SIRET valide - Informations r√©cup√©r√©es</p>
                    }
                    else if (!string.IsNullOrEmpty(siret) && siret.Length == 14)
                    {
                        <p class="mt-1 text-xs text-gray-500">Le SIRET sera v√©rifi√© automatiquement</p>
                    }
                </div>

                <!-- Company Name -->
                <div>
                    <label for="companyName" class="block text-sm font-medium text-gray-700">Nom de l'entreprise *</label>
                    <input id="companyName"
                           type="text"
                           @bind="companyName"
                           required
                           readonly="@siretValidated"
                           class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm @(siretValidated ? "bg-gray-50" : "")"
                           placeholder="Nom de votre soci√©t√©">
                    @if (siretValidated)
                    {
                        <p class="mt-1 text-xs text-green-600">‚úÖ R√©cup√©r√© automatiquement</p>
                    }
                </div>

                <!-- Address -->
                <div>
                    <label for="address" class="block text-sm font-medium text-gray-700">Adresse *</label>
                    <textarea id="address"
                              @bind="address"
                              required
                              rows="2"
                              readonly="@siretValidated"
                              class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm @(siretValidated ? "bg-gray-50" : "")"
                              placeholder="Adresse compl√®te"></textarea>
                    @if (siretValidated)
                    {
                        <p class="mt-1 text-xs text-green-600">‚úÖ R√©cup√©r√© automatiquement</p>
                    }
                </div>

                <!-- Postal Code -->
                <div>
                    <label for="postalCode" class="block text-sm font-medium text-gray-700">Code postal *</label>
                    <input id="postalCode"
                           type="text"
                           @bind="postalCode"
                           required
                           pattern="[0-9]{5}"
                           maxlength="5"
                           readonly="@siretValidated"
                           class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm @(siretValidated ? "bg-gray-50" : "")"
                           placeholder="75001">
                    @if (siretValidated)
                    {
                        <p class="mt-1 text-xs text-green-600">‚úÖ R√©cup√©r√© automatiquement</p>
                    }
                </div>

                <!-- City -->
                <div>
                    <label for="city" class="block text-sm font-medium text-gray-700">Ville *</label>
                    <input id="city"
                           type="text"
                           @bind="city"
                           required
                           readonly="@siretValidated"
                           class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm @(siretValidated ? "bg-gray-50" : "")"
                           placeholder="Paris">
                    @if (siretValidated)
                    {
                        <p class="mt-1 text-xs text-green-600">‚úÖ R√©cup√©r√© automatiquement</p>
                    }
                </div>

                <!-- Site internet -->
                <div>
                    <label for="website" class="block text-sm font-medium text-gray-700">Site internet</label>
                    <input id="website"
                           type="url"
                           @bind="website"
                           class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm"
                           placeholder="https://www.votre-site.com">
                </div>

                <!-- Code APE -->
                @if (siretValidated && !string.IsNullOrEmpty(apeCode))
                {
                    <div>
                        <label for="apeCode" class="block text-sm font-medium text-gray-700">Code APE</label>
                        <input id="apeCode"
                               type="text"
                               value="@apeCode"
                               readonly
                               class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md bg-gray-50 sm:text-sm"
                               placeholder="Code activit√©">
                        <p class="mt-1 text-xs text-green-600">‚úÖ R√©cup√©r√© automatiquement</p>
                    </div>
                }

                <!-- Nom -->
                <div>
                    <label for="lastName" class="block text-sm font-medium text-gray-700">Nom *</label>
                    <input id="lastName"
                           type="text"
                           @bind="lastName"
                           required
                           class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm"
                           placeholder="Dupont">
                </div>

                <!-- Pr√©nom -->
                <div>
                    <label for="firstName" class="block text-sm font-medium text-gray-700">Pr√©nom *</label>
                    <input id="firstName"
                           type="text"
                           @bind="firstName"
                           required
                           class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm"
                           placeholder="Jean">
                </div>

                <!-- T√©l√©phone -->
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700">T√©l√©phone *</label>
                    <input id="phone"
                           type="tel"
                           @bind="phone"
                           required
                           pattern="[0-9]{10}"
                           maxlength="10"
                           class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm"
                           placeholder="0601020304">
                </div>

                <!-- Fonction -->
                <div>
                    <label for="jobTitle" class="block text-sm font-medium text-gray-700">Fonction *</label>
                    <select id="jobTitle"
                            @bind="jobTitle"
                            required
                            class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 text-gray-900 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm">
                        <option value="">-- S√©lectionnez --</option>
                        <option value="Directeur">Directeur / Directrice</option>
                        <option value="ResponsableQualite">Responsable Qualit√© / HSE</option>
                        <option value="ChefEquipe">Chef d'√©quipe</option>
                        <option value="ResponsableOperations">Responsable des op√©rations</option>
                        <option value="Gerant">G√©rant / G√©rante</option>
                        <option value="Other">Autre</option>
                    </select>
                </div>

                <!-- Email -->
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email professionnel *</label>
                    <input id="email"
                           type="email"
                           @bind="email"
                           required
                           class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm"
                           placeholder="contact@entreprise.com">
                </div>

                <!-- Password avec ic√¥ne ≈ìil -->
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Mot de passe *</label>
                    <div class="relative mt-1">
                        <input id="password"
                               type="@(showPassword ? "text" : "password")"
                               @bind="password"
                               required
                               minlength="6"
                               class="appearance-none relative block w-full px-3 py-2 pr-10 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm"
                               placeholder="Min. 6 caract√®res">
                        <button type="button"
                                @onclick="TogglePasswordVisibility"
                                class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                            @if (showPassword)
                            {
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                                </svg>
                            }
                            else
                            {
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            }
                        </button>
                    </div>
                </div>

            </div>

            <div>
                <button type="submit" 
                        disabled="@isLoading"
                        class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    @if (isLoading)
                    {
                        <span>Cr√©ation du compte...</span>
                    }
                    else
                    {
                        <span>Cr√©er mon compte</span>
                    }
                </button>
            </div>

            <div class="text-center">
                <a href="/login" class="font-medium text-indigo-600 hover:text-indigo-500">
                    D√©j√† inscrit ? Se connecter
                </a>
            </div>
        </form>
    </div>
</div>

@code {
    private string email = "";
    private string password = "";
    private string companyName = "";
    private string siret = "";
    private string address = "";
    private string postalCode = "";
    private string city = "";
    private string website = "";
    private string apeCode = "";
    private string lastName = "";
    private string firstName = "";
    private string phone = "";
    private string jobTitle = "";
    private string errorMessage = "";
    private string successMessage = "";
    private bool isLoading = false;
    private bool isValidatingSiret = false;
    private bool siretValidated = false;
    private bool showPassword = false;

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }

    private void OnSiretChange(ChangeEventArgs e)
    {
        // Le JavaScript natif a d√©j√† nettoy√© la valeur (supprim√© espaces et limit√© √† 14 chiffres)
        // On met juste √† jour la variable Blazor avec la valeur nettoy√©e
        siret = e.Value?.ToString() ?? "";
    }

    private async Task ValidateSiret()
    {
        // V√©rifier que le SIRET a exactement 14 chiffres
        if (string.IsNullOrEmpty(siret) || siret.Length != 14 || !siret.All(char.IsDigit))
        {
            return;
        }

        isValidatingSiret = true;
        errorMessage = "";
        successMessage = "";
        siretValidated = false;

        try
        {
            // Appel au backend qui utilisera l'API INSEE avec authentification
            var response = await Http.GetAsync($"api/siret/validate/{siret}");

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<SiretValidationResult>();

                if (result != null && result.IsValid)
                {
                    // Remplir les champs avec les donn√©es r√©cup√©r√©es
                    companyName = result.CompanyName ?? "";
                    address = result.Address ?? "";
                    postalCode = result.PostalCode ?? "";
                    city = result.City ?? "";
                    apeCode = result.ActivityCode ?? "";

                    siretValidated = true;
                    successMessage = "‚úÖ Informations de l'entreprise r√©cup√©r√©es avec succ√®s !";
                }
                else
                {
                    errorMessage = result?.ErrorMessage ?? "‚ùå SIRET non trouv√© dans la base.";
                }
            }
            else
            {
                var errorResult = await response.Content.ReadFromJsonAsync<SiretValidationResult>();
                errorMessage = errorResult?.ErrorMessage ?? "‚ö†Ô∏è Service de v√©rification temporairement indisponible. Vous pouvez saisir manuellement.";
            }
        }
        catch (Exception ex)
        {
            // En cas d'erreur, on permet la saisie manuelle
            errorMessage = "‚ö†Ô∏è V√©rification automatique impossible. Vous pouvez continuer avec la saisie manuelle.";
            Console.WriteLine($"Erreur SIRET validation: {ex.Message}");
        }
        finally
        {
            isValidatingSiret = false;
        }
    }

    // Classe pour d√©s√©rialiser la r√©ponse du backend
    private class SiretValidationResult
    {
        public bool IsValid { get; set; }
        public string? CompanyName { get; set; }
        public string? Address { get; set; }
        public string? PostalCode { get; set; }
        public string? City { get; set; }
        public string? ActivityCode { get; set; }
        public string? ErrorMessage { get; set; }
    }

    private async Task HandleRegister()
    {
        errorMessage = "";
        successMessage = "";
        isLoading = true;

        try
        {
            // Validation basique
            if (siret.Length != 14 || !siret.All(char.IsDigit))
            {
                errorMessage = "Le SIRET doit contenir exactement 14 chiffres.";
                isLoading = false;
                return;
            }

            if (postalCode.Length != 5 || !postalCode.All(char.IsDigit))
            {
                errorMessage = "Le code postal doit contenir 5 chiffres.";
                isLoading = false;
                return;
            }

            // Appel API inscription
            var (success, apiErrorMessage) = await AuthService.RegisterProfessional(
                email,
                password,
                companyName,
                siret,
                address,
                postalCode,
                city,
                website,
                firstName,
                lastName,
                phone,
                jobTitle
            );

            if (success)
            {
                successMessage = "‚úÖ Compte cr√©√© avec succ√®s ! Redirection vers votre commande...";
                await Task.Delay(2000);
                Navigation.NavigateTo("/order-chips");
            }
            else
            {
                errorMessage = apiErrorMessage ?? "√âchec de l'inscription. V√©rifiez vos informations.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Erreur : {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
