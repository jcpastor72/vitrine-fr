@page "/industries"
@using System.Net.Http.Json
@using System.Net.Http.Headers
@using VitrineFr.Services
@using Microsoft.JSInterop
@inject HttpClient Http
@inject NavigationManager Navigation
@inject AuthService AuthService
@inject IJSRuntime JSRuntime

<PageTitle>Métiers - Labor Control</PageTitle>

<link href="css/professional.css" rel="stylesheet" />

<div class="min-h-screen bg-gray-50 py-8 px-4">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <button @onclick="NavigateToDashboard"
                    class="lc-btn lc-btn-secondary inline-flex items-center mb-4">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Retour
            </button>

            <div class="flex justify-between items-center flex-wrap gap-4">
                <div>
                    <h1 class="lc-heading-1">Métiers</h1>
                    <p class="lc-text-muted mt-1">Activez les métiers correspondant à votre activité</p>
                </div>
                <div class="flex gap-3">
                    <a href="/sectors"
                       class="lc-btn lc-btn-secondary inline-flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        Gérer les secteurs
                    </a>
                    <button @onclick="OpenCreateModal"
                            class="lc-btn lc-btn-primary inline-flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Métier personnalisé
                    </button>
                </div>
            </div>

            <!-- Sector Filter -->
            <div class="mt-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Filtrer par secteur
                </label>
                <select @onchange="OnSectorFilterChange"
                        class="w-full md:w-96 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Tous les secteurs</option>
                    @foreach (var sector in sectors.OrderBy(s => s.DisplayOrder).ThenBy(s => s.Name))
                    {
                        <option value="@sector.Id" selected="@(selectedSectorId == sector.Id)">
                            @sector.Icon @sector.Name (@sector.IndustriesCount métiers)
                        </option>
                    }
                </select>
            </div>
        </div>

        <!-- Loading -->
        @if (isLoading)
        {
            <div class="text-center py-20">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                <p class="mt-4 lc-text-muted">Chargement des métiers...</p>
            </div>
        }
        else if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg">
                @errorMessage
            </div>
        }
        else if (allIndustries.Count == 0 && sectors.Count == 0)
        {
            <div class="bg-white border border-gray-200 rounded-lg p-12 text-center">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Aucun secteur d'activité</h3>
                <p class="lc-text-muted mb-6">Commencez par activer vos secteurs d'activité pour accéder aux métiers correspondants</p>
                <a href="/sectors"
                   class="lc-btn lc-btn-primary inline-flex items-center">
                    Activer des secteurs
                </a>
            </div>
        }
        else if (allIndustries.Count == 0 && selectedSectorId.HasValue)
        {
            <div class="bg-white border border-gray-200 rounded-lg p-12 text-center">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Aucun métier dans ce secteur</h3>
                <p class="lc-text-muted mb-6">Initialisez les métiers prédéfinis pour ce secteur</p>
                <button @onclick="InitPredefinedIndustries"
                        disabled="@isInitializing"
                        class="lc-btn lc-btn-primary disabled:opacity-50">
                    @(isInitializing ? "Initialisation..." : "Initialiser les métiers prédéfinis")
                </button>
            </div>
        }
        else
        {
            <!-- Active Industries -->
            @if (activeIndustries.Count > 0)
            {
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="lc-heading-2">Métiers activés (@activeIndustries.Count)</h2>
                        <button @onclick="NavigateToDashboard"
                                class="lc-btn lc-btn-primary">
                            Valider mon choix
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        @foreach (var industry in activeIndustries.OrderBy(i => i.DisplayOrder).ThenBy(i => i.Name))
                        {
                            <div class="bg-white border rounded-lg p-6 hover:shadow-md transition-all"
                                 style="border-left: 4px solid @(industry.Color ?? industry.SectorColor ?? "#10B981")">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex items-center flex-1">
                                        @if (!string.IsNullOrEmpty(industry.Icon))
                                        {
                                            <span class="text-3xl mr-3">@industry.Icon</span>
                                        }
                                        <div class="flex-1">
                                            <h3 class="text-lg font-semibold text-gray-900">@industry.Name</h3>
                                            @if (industry.IsPredefined)
                                            {
                                                <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mt-1">Prédéfini</span>
                                            }
                                            else
                                            {
                                                <span class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded mt-1">Personnalisé</span>
                                            }
                                        </div>
                                    </div>
                                    <div class="flex gap-2 ml-2">
                                        @if (!industry.IsPredefined)
                                        {
                                            <button @onclick="() => OpenEditModal(industry)"
                                                    class="text-blue-600 hover:text-blue-800 p-1"
                                                    title="Modifier">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                </svg>
                                            </button>
                                        }
                                        <button @onclick="() => ToggleIndustry(industry)"
                                                class="text-red-600 hover:text-red-800 p-1"
                                                title="Désactiver">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                                @if (!string.IsNullOrEmpty(industry.Description))
                                {
                                    <p class="lc-text-muted text-sm mb-4">@industry.Description</p>
                                }

                                <!-- Sector Badge -->
                                <div class="pt-4 border-t border-gray-100">
                                    <div class="inline-flex items-center px-3 py-1 rounded-full text-sm"
                                         style="background-color: @(industry.SectorColor ?? "#E5E7EB")20; color: @(industry.SectorColor ?? "#6B7280")">
                                        @if (!string.IsNullOrEmpty(industry.SectorIcon))
                                        {
                                            <span class="mr-1">@industry.SectorIcon</span>
                                        }
                                        <span class="font-semibold">@industry.SectorName</span>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Inactive Industries -->
            @if (inactiveIndustries.Count > 0)
            {
                <div>
                    <h2 class="lc-heading-2 mb-4">Métiers disponibles (@inactiveIndustries.Count)</h2>
                    <p class="lc-text-muted mb-4">Cliquez sur un métier pour l'activer</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        @foreach (var industry in inactiveIndustries.OrderBy(i => i.DisplayOrder).ThenBy(i => i.Name))
                        {
                            <button @onclick="() => ToggleIndustry(industry)"
                                    class="bg-gray-50 border rounded-lg p-6 hover:border-blue-400 hover:bg-white transition-all text-left opacity-60 hover:opacity-100"
                                    style="border-left: 4px solid @(industry.Color ?? industry.SectorColor ?? "#3B82F6")">
                                <div class="flex items-center mb-3">
                                    @if (!string.IsNullOrEmpty(industry.Icon))
                                    {
                                        <span class="text-3xl mr-3 opacity-50">@industry.Icon</span>
                                    }
                                    <div class="flex-1">
                                        <h3 class="text-lg font-semibold text-gray-900">@industry.Name</h3>
                                        @if (industry.IsPredefined)
                                        {
                                            <span class="inline-block bg-gray-200 text-gray-600 text-xs px-2 py-1 rounded mt-1">Prédéfini</span>
                                        }
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                </div>

                                @if (!string.IsNullOrEmpty(industry.Description))
                                {
                                    <p class="lc-text-muted text-sm mb-3">@industry.Description</p>
                                }

                                <!-- Sector Badge -->
                                <div class="inline-flex items-center px-3 py-1 rounded-full text-sm"
                                     style="background-color: @(industry.SectorColor ?? "#E5E7EB")20; color: @(industry.SectorColor ?? "#6B7280")">
                                    @if (!string.IsNullOrEmpty(industry.SectorIcon))
                                    {
                                        <span class="mr-1">@industry.SectorIcon</span>
                                    }
                                    <span class="font-semibold">@industry.SectorName</span>
                                </div>
                            </button>
                        }
                    </div>
                </div>
            }

            <!-- Initialize button if sector selected but no predefined industries -->
            @if (selectedSectorId.HasValue && !allIndustries.Any(i => i.IsPredefined))
            {
                <div class="mt-8 bg-white border border-gray-200 rounded-lg p-6 text-center">
                    <p class="lc-text-muted mb-4">Vous pouvez initialiser les métiers prédéfinis pour ce secteur</p>
                    <button @onclick="InitPredefinedIndustries"
                            disabled="@isInitializing"
                            class="lc-btn lc-btn-primary disabled:opacity-50">
                        @(isInitializing ? "Initialisation..." : "Initialiser les métiers prédéfinis")
                    </button>
                </div>
            }
        }
    </div>
</div>

<!-- Create/Edit Modal (pour métiers personnalisés uniquement) -->
@if (showModal)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-8">
                <h2 class="lc-heading-2 mb-6">
                    @(isEditMode ? "Modifier le métier personnalisé" : "Nouveau métier personnalisé")
                </h2>

                @if (!string.IsNullOrEmpty(modalErrorMessage))
                {
                    <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-6">
                        @modalErrorMessage
                    </div>
                }

                <div class="space-y-6">
                    <!-- Sector Selection -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Secteur d'activité <span class="text-red-500">*</span>
                        </label>
                        @if (sectors.Count == 0)
                        {
                            <div class="bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded-lg">
                                Aucun secteur disponible. <a href="/sectors" class="underline font-semibold">Créer un secteur d'abord</a>
                            </div>
                        }
                        else
                        {
                            <select @bind="formSectorId"
                                    required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Sélectionnez un secteur</option>
                                @foreach (var sector in sectors.OrderBy(s => s.DisplayOrder).ThenBy(s => s.Name))
                                {
                                    <option value="@sector.Id">@sector.Icon @sector.Name</option>
                                }
                            </select>
                        }
                    </div>

                    <!-- Name -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Nom du métier <span class="text-red-500">*</span>
                        </label>
                        <input @bind="formName"
                               type="text"
                               placeholder="Ex: Technicien de maintenance"
                               required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                    </div>

                    <!-- Code -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Code (optionnel)
                        </label>
                        <input @bind="formCode"
                               type="text"
                               placeholder="Ex: TECH_MAINT"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                    </div>

                    <!-- Description -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Description (optionnelle)
                        </label>
                        <textarea @bind="formDescription"
                                  rows="3"
                                  placeholder="Description du métier..."
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>


                </div>

                <!-- Actions -->
                <div class="flex gap-4 mt-8">
                    <button @onclick="CloseModal"
                            class="flex-1 lc-btn lc-btn-secondary">
                        Annuler
                    </button>
                    <button @onclick="SaveIndustry"
                            disabled="@isSaving"
                            class="flex-1 lc-btn lc-btn-primary disabled:opacity-50">
                        @(isSaving ? "Enregistrement..." : isEditMode ? "Mettre à jour" : "Créer")
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<IndustryDto> allIndustries = new();
    private List<IndustryDto> activeIndustries => allIndustries.Where(i => i.IsActive).ToList();
    private List<IndustryDto> inactiveIndustries => allIndustries.Where(i => !i.IsActive).ToList();

    private List<SectorDto> sectors = new();
    private bool isLoading = true;
    private bool isInitializing = false;
    private string? errorMessage;
    private Guid? selectedSectorId;

    // Modal
    private bool showModal = false;
    private bool isEditMode = false;
    private bool isSaving = false;
    private Guid? editingId;
    private string? modalErrorMessage;

    // Form fields
    private string formSectorId = "";
    private string formName = "";
    private string? formCode;
    private string? formDescription;

    protected override async Task OnInitializedAsync()
    {
        // Check for sectorId query parameter
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        var sectorIdParam = query["sectorId"];
        if (!string.IsNullOrEmpty(sectorIdParam) && Guid.TryParse(sectorIdParam, out var sectorId))
        {
            selectedSectorId = sectorId;
        }

        await LoadSectors();
        await LoadIndustries();
    }

    private async Task LoadSectors()
    {
        try
        {
            var token = await AuthService.GetTokenAsync();
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

            var response = await Http.GetFromJsonAsync<List<SectorDto>>("http://localhost:5278/api/sectors?isActive=true");
            sectors = response ?? new List<SectorDto>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors du chargement des secteurs: {ex}");
        }
    }

    private async Task LoadIndustries()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var token = await AuthService.GetTokenAsync();
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

            // Load ALL industries (active and inactive) for the selected sector or all
            var url = selectedSectorId.HasValue
                ? $"http://localhost:5278/api/industries?sectorId={selectedSectorId.Value}"
                : "http://localhost:5278/api/industries";

            var response = await Http.GetFromJsonAsync<List<IndustryDto>>(url);
            allIndustries = response ?? new List<IndustryDto>();
        }
        catch (Exception ex)
        {
            errorMessage = $"Erreur lors du chargement: {ex.Message}";
            Console.WriteLine($"Erreur: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnSectorFilterChange(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        selectedSectorId = string.IsNullOrEmpty(value) ? null : Guid.Parse(value);
        await LoadIndustries();
    }

    private async Task InitPredefinedIndustries()
    {
        if (!selectedSectorId.HasValue)
        {
            errorMessage = "Veuillez sélectionner un secteur d'abord";
            return;
        }

        try
        {
            isInitializing = true;
            errorMessage = null;

            var token = await AuthService.GetTokenAsync();
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

            var response = await Http.PostAsync($"http://localhost:5278/api/industries/init-predefined/{selectedSectorId.Value}", null);

            if (response.IsSuccessStatusCode)
            {
                await LoadSectors(); // Refresh sector counts
                await LoadIndustries();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                errorMessage = $"Erreur lors de l'initialisation: {error}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Erreur: {ex.Message}";
            Console.WriteLine($"Erreur: {ex}");
        }
        finally
        {
            isInitializing = false;
        }
    }

    private async Task ToggleIndustry(IndustryDto industry)
    {
        try
        {
            var token = await AuthService.GetTokenAsync();
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

            // Use the dedicated toggle endpoint
            var response = await Http.PostAsync($"http://localhost:5278/api/industries/{industry.Id}/toggle", null);

            if (response.IsSuccessStatusCode)
            {
                await LoadSectors(); // Refresh sector counts
                await LoadIndustries(); // Refresh from server
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                errorMessage = $"Erreur: {error}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Erreur: {ex.Message}";
            Console.WriteLine($"Erreur: {ex}");
        }
    }

    private void OpenCreateModal()
    {
        if (sectors.Count == 0)
        {
            errorMessage = "Veuillez d'abord créer un secteur d'activité";
            return;
        }

        isEditMode = false;
        editingId = null;
        ResetForm();

        // Pre-select sector if filtered
        if (selectedSectorId.HasValue)
        {
            formSectorId = selectedSectorId.Value.ToString();
        }

        showModal = true;
    }

    private void OpenEditModal(IndustryDto industry)
    {
        isEditMode = true;
        editingId = industry.Id;
        formSectorId = industry.SectorId.ToString();
        formName = industry.Name;
        formCode = industry.Code;
        formDescription = industry.Description;
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
        modalErrorMessage = null;
        ResetForm();
    }

    private void ResetForm()
    {
        formSectorId = "";
        formName = "";
        formCode = null;
        formDescription = null;
    }

    private async Task SaveIndustry()
    {
        try
        {
            isSaving = true;
            modalErrorMessage = null;

            // Validation
            if (string.IsNullOrWhiteSpace(formName))
            {
                modalErrorMessage = "Le nom est obligatoire";
                return;
            }

            if (string.IsNullOrWhiteSpace(formSectorId) || !Guid.TryParse(formSectorId, out var sectorId))
            {
                modalErrorMessage = "Le secteur est obligatoire";
                return;
            }

            var token = await AuthService.GetTokenAsync();
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

            var request = new
            {
                SectorId = sectorId,
                Name = formName,
                Code = formCode,
                Description = formDescription
            };

            HttpResponseMessage response;

            if (isEditMode && editingId.HasValue)
            {
                response = await Http.PutAsJsonAsync($"http://localhost:5278/api/industries/{editingId.Value}", request);
            }
            else
            {
                response = await Http.PostAsJsonAsync("http://localhost:5278/api/industries", request);
            }

            if (response.IsSuccessStatusCode)
            {
                CloseModal();
                await LoadSectors(); // Refresh sector counts
                await LoadIndustries();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                modalErrorMessage = $"Erreur: {error}";
            }
        }
        catch (Exception ex)
        {
            modalErrorMessage = $"Erreur: {ex.Message}";
            Console.WriteLine($"Erreur: {ex}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private void NavigateToDashboard()
    {
        Navigation.NavigateTo("/dashboard");
    }

    public class IndustryDto
    {
        public Guid Id { get; set; }
        public Guid SectorId { get; set; }
        public string SectorName { get; set; } = string.Empty;
        public string? SectorColor { get; set; }
        public string? SectorIcon { get; set; }
        public string Name { get; set; } = string.Empty;
        public string? Code { get; set; }
        public string? Description { get; set; }
        public string? Color { get; set; }
        public string? Icon { get; set; }
        public int DisplayOrder { get; set; }
        public bool IsPredefined { get; set; }
        public bool IsActive { get; set; }
        public DateTime CreatedAt { get; set; }
    }

    public class SectorDto
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string? Code { get; set; }
        public string? Description { get; set; }
        public string? Color { get; set; }
        public string? Icon { get; set; }
        public int DisplayOrder { get; set; }
        public bool IsActive { get; set; }
        public DateTime CreatedAt { get; set; }
        public int IndustriesCount { get; set; }
    }
}
